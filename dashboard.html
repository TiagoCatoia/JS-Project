<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/3e656cdace.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <title>Dashboard</title>
</head>
<body>
    <script>
    // node index.js para iniciar o servidor
        var urlParams = new URLSearchParams(window.location.search)
        var usuario = urlParams.get("parametro")

        if (usuario === null) {
            window.location.href = "login.html"
        }
        dashboard(usuario)

        function dashboard(usuario) {

            var body = document.querySelector("body")
            var dashboard = document.createElement("div")
            dashboard.id = "dashboard"
            body.appendChild(dashboard)

            // Cria a div da esquerda do gráfico com as escolhas
            var divEsquerda = document.createElement("div")
            divEsquerda.id = "divEsq"
            dashboard.appendChild(divEsquerda)

            // Cria a div em que os gráficos aparecerão
            var divGrafico = document.createElement("div")
            divGrafico.id = "divGraf"
            dashboard.appendChild(divGrafico)
            
            // Cria a escolha do gráfico
            function escolhaDosGraficos() {
                divGrafico.innerHTML = 
                `<div id='graficoArea'>
                    <h1>Dashboard</h1>
                    <div id='escolhaGrafico'>
                        <div id="variacaoPercentual"><h2>Variação Percentual<h2><i id='iconGraf' class="fa-solid fa-chart-line"></i></div>
                        <div id="outroGrafico"><h2>Outro Grafico<h2><i id='iconGraf' class="fa-solid fa-chart-simple"></i></div>
                    </div>
                </div>`
            }
            escolhaDosGraficos()

            var conteudoDivEsquerda = document.createElement("div")
            conteudoDivEsquerda.id = "conteudoDivEsquerda"

            // Cria o conteúdo da barra Lateral
            conteudoDivEsquerda.innerHTML =
            `<i id='iconDivEsq' class="fa-solid fa-user"></i>
            <h2 id="user">${usuario}</h2>
            <br>
            <h3 id="acaoAnalisada">Ação Analisada:<br></h3>
            <h3 id="acaoAnalisadaLinha"></h3>
            <br>
            <h3 id="dataAnalisada">Período Analisado:</h3>
            <h4 id="dataAnalisadaLinha"></h4>
            <h3 id="tipoGraf">Gráfico:</h3>
            <h3 id="linhaTipoGraf"></h3>`

            divEsquerda.appendChild(conteudoDivEsquerda)

            // Volta para tela de login se apertar o ícone de usuário
            var userIcon = document.querySelector("#iconDivEsq")
            userIcon.addEventListener("click", function() {
                window.location.href = "login.html"
            })

            // Armazena qual vai ser o gráfico escolhido pelo usuário
            var tipoDoGrafico

            // 1º Opção dos Gráficos (divGrafico)
            var variacaoPercentual = document.querySelector("#variacaoPercentual")
            variacaoPercentual.addEventListener("click", function() {

                var linhaTipoGraf = document.querySelector("#linhaTipoGraf")
                linhaTipoGraf.innerText = "Variação Percentual"
                tipoDoGrafico = "Variação Percentual"
                opcoesParaGrafico(tipoDoGrafico)
            })

            // 2º Opção dos Gráficos (divGrafico)
            var outroGrafico = document.querySelector("#outroGrafico")
            outroGrafico.addEventListener("click", function() {
                var linhaTipoGraf = document.querySelector("#linhaTipoGraf")
                linhaTipoGraf.innerText = "Outro Gráfico"
                tipoDoGrafico = "Outro Gráfico"
                opcoesParaGrafico(tipoDoGrafico)
            })

            function opcoesParaGrafico(tipoDoGrafico){
                var conteudoEscolhaGrafico = document.createElement("div")
                conteudoEscolhaGrafico.id = "conteudoEscolhaGrafico"

                var escolhaGrafico = document.querySelector("#escolhaGrafico")
                escolhaGrafico.innerHTML = ""
                
                var opcaoesAcoes = document.createElement("div")
                opcaoesAcoes.id = "opcaoesAcoes"
                var divPetr3 = document.createElement("div")
                divPetr3.id = "divPetr3"
                divPetr3.innerHTML = "<h2>PETR3<h2>"
                var divBbas3 = document.createElement("div")
                divBbas3.id = "divBbas3"
                divBbas3.innerHTML = "<h2>BBAS3<h2>"

                // Armazena qual a ação vai ser escolhida pelo usuário
                var acaoAnalisada

                divPetr3.addEventListener("click", function() {
                    divBbas3.style.backgroundColor = "rgb(106, 80, 177)"
                    divPetr3.style.backgroundColor = "rgb(152, 121, 224)"
                    // Envia a ação selecionada para a barra lateral (divEsquerda)
                    acaoAnalisadaLinha.innerText = "PETR3"
                    acaoAnalisada = "PETR3"
                })
                divBbas3.addEventListener("click", function() {
                    divPetr3.style.backgroundColor = "rgb(106, 80, 177)"
                    divBbas3.style.backgroundColor = "rgb(152, 121, 224)"
                    // Envia a ação selecionada para a barra lateral (divEsquerda)
                    acaoAnalisadaLinha.innerText = "BBAS3"
                    acaoAnalisada = "BBAS3"
                })

                // Armazena qual o Intervalo de Tempo que vai ser escolhido pelo usuário
                var inicioIntervalo
                var fimIntervalo


                var opcaoData = document.createElement("div")
                opcaoData.id = "opcaoData"

                // Cria o Calendário
                opcaoData.innerHTML =
                `
                <h2>Intervalo de Tempo</h2>
                <br>
                <div id="reportrange">
                    <i class="fa fa-calendar"></i>&nbsp
                    <span></span> <i class="fa fa-caret-down"></i>
                </div>
                `
                $(function() {
                    var start = moment().subtract(29, 'days')
                    var end = moment()

                    function cb(start, end) {
                        $('#reportrange span').html(' Desde ' + start.format('DD/MM/YYYY') + ' até ' + end.format('DD/MM/YYYY'))
                        var intervaloSelecionado = $('#reportrange span').text()
                        // Armazena o intervalo de tempo
                        inicioIntervalo = `${start.format('YYYY-MM-DD')}`
                        fimIntervalo = `${end.format('YYYY-MM-DD')}`
                        console.log("Intervalo selecionado: " + `${start.format('DD/MM/YYYY')}` + " " + `${end.format('DD/MM/YYYY')}`)
                        // Envia o intervalo selecionado para a barra lateral (divEsquerda)
                        dataAnalisadaLinha.innerText = `${intervaloSelecionado}`
                    }

                    $('#reportrange').daterangepicker({
                        startDate: start,
                        endDate: end,
                        locale: {
                            format: 'DD/MM/YYYY',
                            customRangeLabel: 'Intervalo Personalizado'
                        },
                        ranges: {
                            'Esse Mês': [moment().startOf('month'), moment().endOf('month')],
                            'Mês passado': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                            '2 Meses Atrás': [moment().subtract(2, 'months').startOf('month'), moment().subtract(2, 'months').endOf('month')],
                            '3 Meses Atrás': [moment().subtract(3, 'months').startOf('month'), moment().subtract(3, 'months').endOf('month')],
                            'Ano Passado': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')],
                            'Esse Ano': [moment().startOf('year'), moment().endOf('year')]
                        }
                    }, cb)

                    cb(start, end)
                })

                // Container dos botões
                var containerBotoes = document.createElement("div")
                containerBotoes.id = "containerBotoes"

                // Botão que vai retornar a resposta para carregar o gráfico
                var btnCarregar = document.createElement("div")
                btnCarregar.id = "btnCarregar"
                btnCarregar.innerHTML = "<h3>Carregar</h3>"
                containerBotoes.appendChild(btnCarregar)

                btnCarregar.addEventListener("click", function() {
                    // Verifica se o usuário selecionou os campos necessários para gerar o gráfico

                    if (acaoAnalisadaLinha.innerText !== "" && dataAnalisadaLinha.innerText !== "") {
                        // Limpa a região onde o gráfico será mostrado (divGraficoArea)
                        let divGraficoArea = document.getElementById('graficoArea')
                        divGraficoArea. innerHTML = ""

                        // Carrega e Formata os dados para serem usados no gráfico
                        carregarDados(inicioIntervalo, fimIntervalo, acaoAnalisada, tipoDoGrafico)     
                    } else {
                        alert("Ação e/ou Intervalo de Tempo não foram selecionadas.")
                    }
                })

                // Botão para Voltar para Escolha dos Gráficos
                var btnVoltar = document.createElement("div")
                btnVoltar.id = "btnVoltar"
                btnVoltar.innerHTML = "<h3>Voltar</h3>"
                containerBotoes.appendChild(btnVoltar)
                btnVoltar.addEventListener("click", reatribuirEventos)

                // Função para reatribuir eventos
                function reatribuirEventos() {
                    // Chama escolhaDosGraficos() novamente
                    linhaTipoGraf.innerHTML = ""
                    acaoAnalisadaLinha.innerHTML = ""
                    dataAnalisadaLinha.innerHTML = ""
                    escolhaDosGraficos()

                    variacaoPercentual = document.querySelector("#variacaoPercentual")
                    outroGrafico = document.querySelector("#outroGrafico")

                    variacaoPercentual.addEventListener("click", function() {
                        var linhaTipoGraf = document.querySelector("#linhaTipoGraf")
                        linhaTipoGraf.innerText = "Variação Percentual"
                        tipoDoGrafico = "Variação Percentual"
                        opcoesParaGrafico(tipoDoGrafico)
                    })

                    outroGrafico.addEventListener("click", function() {
                        var linhaTipoGraf = document.querySelector("#linhaTipoGraf")
                        linhaTipoGraf.innerText = "Outro Gráfico"
                        tipoDoGrafico = "Outro Gráfico"
                        opcoesParaGrafico(tipoDoGrafico)
                    })
                }
                
                opcaoesAcoes.appendChild(divPetr3)
                opcaoesAcoes.appendChild(divBbas3)
                conteudoEscolhaGrafico.appendChild(opcaoesAcoes)
                conteudoEscolhaGrafico.appendChild(opcaoData)
                conteudoEscolhaGrafico.appendChild(containerBotoes)
                escolhaGrafico.appendChild(conteudoEscolhaGrafico)
            }
        }
        
        // Carrega e Formata os dados para serem usados no gráfico
        function carregarDados(inicioIntervalo, fimIntervalo, acaoAnalisada, tipoDoGrafico) {
            // Variável que acessa todos os dados do servidor
            let dadosAcoes
            // Array que vai armazenar todos os dados no intervalo específico
            let dadosNoIntervalo = []
            // Declare e inicialize as variáveis de intervalo
            let inicioData = new Date(inicioIntervalo)
            let fimData = new Date(fimIntervalo)

            fetch(`http://localhost:8000/historico/${acaoAnalisada}`)
            .then((dadosAcoes)=> {
                console.log("Processando dados...")
                return dadosAcoes.json()
            })
            .then((dadosAcoes)=>{

                for (let i=0; i < dadosAcoes.length; i++) {
                    let dataVerificada = new Date(dadosAcoes[i].Date)

                    // Verifica se a data está entre o período definido pelo usuário
                    if (dataVerificada >= inicioData && dataVerificada <= fimData) {
                        dadosNoIntervalo.push(dadosAcoes[i])
                    }
                }
                // Cria o Gráfico
                criaGrafico(dadosNoIntervalo, tipoDoGrafico, acaoAnalisada)
            })
            .catch((erro)=>{
                console.log(`Erro na requisição: ${erro}`)
            })
            .finally(()=>{
                console.log(`Processamento terminado`)
            })
        }

        function criaGrafico(dadosNoIntervalo, tipoDoGrafico, acaoAnalisada) {

            if (tipoDoGrafico === "Variação Percentual"){
                // Processa os dados para obter as Variações Percentuais e as Datas
                var variacaoDatas = calcularVariacao(dadosNoIntervalo)

                // Onde o Gráfico vai ser implementado
                var divGraficoArea = document.getElementById('graficoArea')
                var canvas = document.createElement("canvas")
                canvas.id = "grafico"
                divGraficoArea.appendChild(canvas)

                // Separa as Datas e as Variações Percentuais
                let datas = []
                let variacoes = []
                for (let i=0; i < variacaoDatas.length; i++) {
                    datas.push(variacaoDatas[i].data)
                    variacoes.push(variacaoDatas[i].variacao)
                }

                // Datas representa a linha horizontal (eixo y)
                var labels = datas
                // Variação Percentual representa a linha vertical (eixo x)
                const dataPoints = variacoes

                const config = {
                    type: 'line', // Define o tipo do Gráfico como em Linha
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Variação Percentual ${acaoAnalisada}`,
                            data: dataPoints, // dataPoints refere-se a uma coleção de pontos de dados
                            fill: false,
                            borderColor: 'rgb(51%, 34%, 90%)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, // Torna o gráfico responsivo
                        scales: {
                            x: {
                                beginAtZero: true
                            },
                            y: {
                                beginAtZero: true,
                                // Use uma função de retorno para formatar os valores do eixo Y
                                ticks: {
                                    callback: function (value) {
                                        return value + '%'; // Adicione o símbolo de porcentagem
                                    }
                                }
                            }
                        }
                    }
                }

                // Renderiza o gráfico no canvas
                const ctx = canvas.getContext('2d')
                new Chart(ctx, config)

            } else if (tipoDoGrafico === "Outro Gráfico") {

            }
        }

        // Calcula a Variação Percentual entre o preço de abertura e fechamento para o período analisado
        function calcularVariacao(dadosNoIntervalo) {
            let variacaoDatas = []
            let variacao
            let data
            for (let i=0; i<dadosNoIntervalo.length; i++) {
                variacao = ( ( dadosNoIntervalo[i].Close - dadosNoIntervalo[i].Open ) / dadosNoIntervalo[i].Open ) * 100
                data = dadosNoIntervalo[i].Date
                variacaoDatas.push({variacao: variacao.toFixed(2), data: data})
            }
            return variacaoDatas
        }
    </script>
</body>
</html>
