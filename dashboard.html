<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/3e656cdace.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <title>Dashboard</title>
</head>
<body>
    <script>
    // node index.js para iniciar o servidor
        var urlParams = new URLSearchParams(window.location.search)
        var usuario = urlParams.get("parametro")

        if (usuario === null) {
            window.location.href = "login.html"
        }
        dashboard(usuario)

        function dashboard(usuario) {

            var body = document.querySelector("body")
            var dashboard = document.createElement("div")
            dashboard.id = "dashboard"
            body.appendChild(dashboard)

            // Cria a div da esquerda do gr√°fico com as escolhas
            var divEsquerda = document.createElement("div")
            divEsquerda.id = "divEsq"
            dashboard.appendChild(divEsquerda)

            // Cria a div em que os gr√°ficos aparecer√£o
            var divGrafico = document.createElement("div")
            divGrafico.id = "divGraf"
            dashboard.appendChild(divGrafico)
            
            // Cria a escolha do gr√°fico
            function escolhaDosGraficos() {
                divGrafico.innerHTML = 
                `<div id='graficoArea'>
                    <h1>üìàDashboardüìâ</h1>
                    <div id='escolhaGrafico'>
                        <div id="gapDeAbertura"><h2>Gap de Abertura<h2><i id='iconGraf' class="fa-solid fa-chart-line"></i></div>
                        <div id="outroGrafico"><h2>Outro Grafico<h2><i id='iconGraf' class="fa-solid fa-chart-simple"></i></div>
                    </div>
                </div>`
            }
            escolhaDosGraficos()

            var conteudoDivEsquerda = document.createElement("div")
            conteudoDivEsquerda.id = "conteudoDivEsquerda"

            // Cria o conte√∫do da barra Lateral
            conteudoDivEsquerda.innerHTML =
            `<i id='iconDivEsq' class="fa-solid fa-user"></i>
            <h2 id="user">${usuario}</h2>
            <br>
            <h3 id="acaoAnalisada">A√ß√£o Analisada:<br></h3>
            <h3 id="acaoAnalisadaLinha"></h3>
            <br>
            <h3 id="dataAnalisada">Per√≠odo Analisado:</h3>
            <h4 id="dataAnalisadaLinha"></h4>
            <h3 id="tipoGraf">Gr√°fico:</h3>
            <h3 id="linhaTipoGraf"></h3>`

            divEsquerda.appendChild(conteudoDivEsquerda)

            // Volta para tela de login se apertar o √≠cone de usu√°rio
            var userIcon = document.querySelector("#iconDivEsq")
            userIcon.addEventListener("click", function() {
                window.location.href = "login.html"
            })

            // Armazena qual vai ser o gr√°fico escolhido pelo usu√°rio
            var tipoDoGrafico

            // 1¬∫ Op√ß√£o dos Gr√°ficos (divGrafico)
            var gapDeAbertura = document.querySelector("#gapDeAbertura")
            gapDeAbertura.addEventListener("click", function() {

                var linhaTipoGraf = document.querySelector("#linhaTipoGraf")
                linhaTipoGraf.innerText = "Gap de Abertura"
                tipoDoGrafico = "Gap de Abertura"
                opcoesParaGrafico(tipoDoGrafico)
            })

            // 2¬∫ Op√ß√£o dos Gr√°ficos (divGrafico)
            var outroGrafico = document.querySelector("#outroGrafico")
            outroGrafico.addEventListener("click", function() {
                var linhaTipoGraf = document.querySelector("#linhaTipoGraf")
                linhaTipoGraf.innerText = "Outro Gr√°fico"
                tipoDoGrafico = "Outro Gr√°fico"
                opcoesParaGrafico(tipoDoGrafico)
            })

            function opcoesParaGrafico(tipoDoGrafico){
                var conteudoEscolhaGrafico = document.createElement("div")
                conteudoEscolhaGrafico.id = "conteudoEscolhaGrafico"

                var escolhaGrafico = document.querySelector("#escolhaGrafico")
                escolhaGrafico.innerHTML = ""
                
                var opcaoesAcoes = document.createElement("div")
                opcaoesAcoes.id = "opcaoesAcoes"
                var divPetr3 = document.createElement("div")
                divPetr3.id = "divPetr3"
                divPetr3.innerHTML = "<h2>PETR3<h2>"
                var divBbas3 = document.createElement("div")
                divBbas3.id = "divBbas3"
                divBbas3.innerHTML = "<h2>BBAS3<h2>"

                // Armazena qual a a√ß√£o vai ser escolhida pelo usu√°rio
                var acaoAnalisada

                divPetr3.addEventListener("click", function() {
                    divBbas3.style.backgroundColor = "rgb(106, 80, 177)"
                    divPetr3.style.backgroundColor = "rgb(152, 121, 224)"
                    // Envia a a√ß√£o selecionada para a barra lateral (divEsquerda)
                    acaoAnalisadaLinha.innerText = "PETR3"
                    acaoAnalisada = "PETR3"
                })
                divBbas3.addEventListener("click", function() {
                    divPetr3.style.backgroundColor = "rgb(106, 80, 177)"
                    divBbas3.style.backgroundColor = "rgb(152, 121, 224)"
                    // Envia a a√ß√£o selecionada para a barra lateral (divEsquerda)
                    acaoAnalisadaLinha.innerText = "BBAS3"
                    acaoAnalisada = "BBAS3"
                })

                // Armazena qual o Intervalo de Tempo que vai ser escolhido pelo usu√°rio
                var inicioIntervalo
                var fimIntervalo


                var opcaoData = document.createElement("div")
                opcaoData.id = "opcaoData"

                // Cria o Calend√°rio
                opcaoData.innerHTML =
                `
                <h2>Intervalo de Tempo</h2>
                <br>
                <div id="reportrange">
                    <i class="fa fa-calendar"></i>&nbsp
                    <span></span> <i class="fa fa-caret-down"></i>
                </div>
                `
                $(function() {
                    var start = moment().subtract(29, 'days')
                    var end = moment()

                    function cb(start, end) {
                        $('#reportrange span').html(' Desde ' + start.format('DD/MM/YYYY') + ' at√© ' + end.format('DD/MM/YYYY'))
                        var intervaloSelecionado = $('#reportrange span').text()
                        // Armazena o intervalo de tempo
                        inicioIntervalo = `${start.format('YYYY-MM-DD')}`
                        fimIntervalo = `${end.format('YYYY-MM-DD')}`
                        console.log("Intervalo selecionado: " + `${start.format('DD/MM/YYYY')}` + " " + `${end.format('DD/MM/YYYY')}`)
                        // Envia o intervalo selecionado para a barra lateral (divEsquerda)
                        dataAnalisadaLinha.innerText = `${intervaloSelecionado}`
                    }

                    $('#reportrange').daterangepicker({
                        startDate: start,
                        endDate: end,
                        locale: {
                            format: 'DD/MM/YYYY',
                            customRangeLabel: 'Intervalo Personalizado'
                        },
                        ranges: {
                            'Hoje': [moment(), moment()],
                            'Ontem': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                            '√öltimos 7 dias': [moment().subtract(6, 'days'), moment()],                       ///////////////// MELHORAR AS OP√á√îES *****************************
                            '√öltimos 30 dias': [moment().subtract(29, 'days'), moment()],
                            'Esse M√™s': [moment().startOf('month'), moment().endOf('month')],
                            'M√™s passado': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                        }
                    }, cb)

                    cb(start, end)
                })

                // Container dos bot√µes
                var containerBotoes = document.createElement("div")
                containerBotoes.id = "containerBotoes"

                // Bot√£o que vai retornar a resposta para carregar o gr√°fico
                var btnCarregar = document.createElement("div")
                btnCarregar.id = "btnCarregar"
                btnCarregar.innerHTML = "<h3>Carregar</h3>"
                containerBotoes.appendChild(btnCarregar)

                btnCarregar.addEventListener("click", function() {
                    // Verifica se o usu√°rio selecionou os campos necess√°rios para gerar o gr√°fico

                    if (acaoAnalisadaLinha.innerText !== "" && dataAnalisadaLinha.innerText !== "") {
                        // Limpa a regi√£o onde o gr√°fico ser√° mostrado (divGraficoArea)
                        let divGraficoArea = document.getElementById('graficoArea')
                        divGraficoArea. innerHTML = ""

                        // Carrega e Formata os dados para serem usados no gr√°fico
                        carregarDados(inicioIntervalo, fimIntervalo, acaoAnalisada, tipoDoGrafico)     
                    } else {
                        alert("A√ß√£o e/ou Intervalo de Tempo n√£o foram selecionadas.")
                    }
                })

                // Bot√£o para Voltar para Escolha dos Gr√°ficos
                var btnVoltar = document.createElement("div")
                btnVoltar.id = "btnVoltar"
                btnVoltar.innerHTML = "<h3>Voltar</h3>"
                containerBotoes.appendChild(btnVoltar)
                btnVoltar.addEventListener("click", reatribuirEventos)

                // Fun√ß√£o para reatribuir eventos
                function reatribuirEventos() {
                    // Chama escolhaDosGraficos() novamente
                    linhaTipoGraf.innerHTML = ""
                    acaoAnalisadaLinha.innerHTML = ""
                    dataAnalisadaLinha.innerHTML = ""
                    escolhaDosGraficos()

                    gapDeAbertura = document.querySelector("#gapDeAbertura")
                    outroGrafico = document.querySelector("#outroGrafico")

                    gapDeAbertura.addEventListener("click", function() {
                        var linhaTipoGraf = document.querySelector("#linhaTipoGraf")
                        linhaTipoGraf.innerText = "Gap de Abertura"
                        tipoDoGrafico = "Gap de Abertura"
                        opcoesParaGrafico(tipoDoGrafico)
                    })

                    outroGrafico.addEventListener("click", function() {
                        var linhaTipoGraf = document.querySelector("#linhaTipoGraf")
                        linhaTipoGraf.innerText = "Outro Gr√°fico"
                        tipoDoGrafico = "Outro Gr√°fico"
                        opcoesParaGrafico(tipoDoGrafico)
                    })
                }
                
                opcaoesAcoes.appendChild(divPetr3)
                opcaoesAcoes.appendChild(divBbas3)
                conteudoEscolhaGrafico.appendChild(opcaoesAcoes)
                conteudoEscolhaGrafico.appendChild(opcaoData)
                conteudoEscolhaGrafico.appendChild(containerBotoes)
                escolhaGrafico.appendChild(conteudoEscolhaGrafico)
            }
        }
        
        // Carrega e Formata os dados para serem usados no gr√°fico
        function carregarDados(inicioIntervalo, fimIntervalo, acaoAnalisada, tipoDoGrafico) {
            // Vari√°vel que acessa todos os dados do arquivo
            let dadosAcoes
            // Array que vai armazenar todos os dados no intervalo espec√≠fico
            let dadosNoIntervalo = []
            // Declare e inicialize as vari√°veis de intervalo
            let inicioData = new Date(inicioIntervalo)
            let fimData = new Date(fimIntervalo)
            console.log(inicioData)
            console.log(fimData)

            fetch(`http://localhost:8000/historico/${acaoAnalisada}`)
            .then((dadosAcoes)=> {
                console.log("Processando dados...")
                return dadosAcoes.json()
            })
            .then((dadosAcoes)=>{

                for (let i=0; i < dadosAcoes.length; i++) {
                    let dataVerificada = new Date(dadosAcoes[i].Date)

                    if (dataVerificada >= inicioData && dataVerificada <= fimData) {
                        dadosNoIntervalo.push(dadosAcoes[i])
                    }
                }
                console.log(dadosNoIntervalo)
                // Cria o Gr√°fico
                criaGrafico(dadosNoIntervalo, tipoDoGrafico)
            })
            .catch((erro)=>{
                console.log(`Erro na requisi√ß√£o: ${erro}`)
            })
            .finally(()=>{
                console.log(`Processamento terminado`)
            })
        }

        /* Cria o Gr√°fico de Gap de Abertura: (Gr√°fico em Linha)

        Diferen√ßa entre o pre√ßo de fechamento (Close) e o pre√ßo de abertura (Open),
        usada para avaliar o comportamento de pre√ßos em um dia espec√≠fico em rela√ß√£o aos dias anteriores.
        - Gap de Alta (Bullish Gap): O pre√ßo de abertura √© maior do que o pre√ßo de fechamento do dia anterior. Indica um sentimento positivo no mercado.
        - Gap de Baixa (Bearish Gap): O pre√ßo de abertura √© menor do que o pre√ßo de fechamento do dia anterior. Indica um sentimento negativo no mercado.
        - Gap de Exaust√£o (Exhaustion Gap): Ocorre ap√≥s uma tend√™ncia significativa e indica uma poss√≠vel revers√£o da tend√™ncia atual.
        */
        function criaGrafico(dadosNoIntervalo, tipoDoGrafico) {

            if (tipoDoGrafico === "Gap de Abertura"){

            } else if (tipoDoGrafico === "Outro Gr√°fico") {

            }
            var divGraficoArea = document.getElementById('graficoArea')
            var canvas = document.createElement("canvas")
            canvas.id = "grafico"
            divGraficoArea.appendChild(canvas)

            let meses = []
            let meses2022 = []
            let meses2023 = []
            let precoAbertura = []
            let precoFechamento = []
            let precoAbertura2022 = []
            let precoFechamento2022 = []
            let precoAbertura2023 = []
            let precoFechamento2023 = []
            let i = 0
            for (i=0; i<250; i++) {
                meses.push(cotacao[i].Date)
                precoAbertura.push(cotacao[i].Open)
                precoFechamento.push(cotacao[i].Close)
            }
            if (ano === "2022") {
                for (i=0; i<250; i++) { // dados de 59 dias em 2022 (Usando metade: i+=2)
                    if (meses[i][3] === "2") { // caso o ano seja 2022
                        meses2022.push(meses[i][5] + meses[i][6] + "/" + meses[i][8] + meses[i][9])
                        precoAbertura2022.push(precoAbertura[i])
                        precoFechamento2022.push(precoFechamento[i])
                    }
                }
                var gapDeAbertura = calcularGap(precoAbertura2022, precoFechamento2022) // Calcula o valor do gab de abertura do ano 2022
                var labels = meses2022// R√≥tulos para o eixo X
            } else {
                for (i=0; i<250; i++) { // dados de 191 dias de 2023 (Usando 1/6: i+=6)
                    if (meses[i][3] === "3") { // caso o ano seja 2023
                        meses2023.push(meses[i][5] + meses[i][6] + "/" + meses[i][8] + meses[i][9])
                        precoAbertura2023.push(precoAbertura[i])
                        precoFechamento2023.push(precoFechamento[i])
                    }
                }
                var gapDeAbertura = calcularGap(precoAbertura2023, precoFechamento2023) // Calcula o valor do gab de abertura do ano 2023
                var labels = meses2023// R√≥tulos para o eixo X
            }

            // Implementa√ß√£o do Gr√°fico
            const dataPoints = gapDeAbertura // Valores para o eixo Y

            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Gaps de Abertura PETR3`,
                        data: dataPoints,
                        fill: false,
                        borderColor: 'rgb(51%, 34%, 90%)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true, // Torna o gr√°fico responsivo
                    scales: {
                        x: {
                            beginAtZero: true
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            }

            // Renderiza o gr√°fico no canvas
            const ctx = canvas.getContext('2d')
            new Chart(ctx, config)
        }

        function calcularGap(precoAberturaAno, precoFechamentoAno) {
            let gapDeAbertura = []
            for (let i=0; i<precoAberturaAno.length; i++) {
                gapDeAbertura.push(precoFechamentoAno[i] - precoAberturaAno[i])
            }
            return gapDeAbertura
        }
    </script>
</body>
</html>
