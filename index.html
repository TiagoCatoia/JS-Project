<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/3e656cdace.js" crossorigin="anonymous"></script>
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
    <title>Dashboard PETR3</title>
</head>
<body>
    <div id="container">
        <div id="divPlataforma">
            <h1>
                Faça seu login
                <br>
                na plataforma
            </h1>
        </div>
        <div id="containerLogin">
            <div id="divUsuario">
                <i id="Icon" class="fa-regular fa-user"></i>
                <input type="text" id="usuario" name="usuario" placeholder="Usuário" value="Tiago Catoia">
            </div>
            <div id="divSenha">
                <i id="Icon" class="fa-solid fa-unlock"></i>
                <input type="password" id="senha" name="senha" placeholder="Senha" value="senha">
            </div>
            <div id="divEnvio">
                <button type="submit" id="btnEnvio">Entrar</button>
            </div><br>
            <div id="linhaDivisao"></div><br>
            <div id="divCadastro">
                Não tem uma conta?<a id="textCadastro" href="cadastro.html">Registre-se</a>
            </div>
        </div>
    </div>
    <script>
    // node index.js para iniciar o servidor
    /*
    Gráfico de Linha:
    Gap de abertura: Diferença entre o preço de fechamento (Close) e o preço de abertura (Open),
    usada para avaliar o comportamento de preços em um dia específico em relação ao dia anterior.

    - Gap de Alta (Bullish Gap): O preço de abertura é maior do que o preço de fechamento do dia anterior. Indica um sentimento positivo no mercado.

    - Gap de Baixa (Bearish Gap): O preço de abertura é menor do que o preço de fechamento do dia anterior. Indica um sentimento negativo no mercado.

    - Gap de Exaustão (Exhaustion Gap): Ocorre após uma tendência significativa e indica uma possível reversão da tendência atual.
    */
        var btnSubmit = document.querySelector("#btnEnvio")
        btnSubmit.addEventListener("click", function () {
            login(btnSubmit)
        })

        function login() {
            let usuario = document.querySelector("#usuario").value
            let senha = document.querySelector("#senha").value

            if (usuario === "" || senha === "") {
                alert("Preencha corretamente o Usuário e a Senha!")
            } else {
                // Obtém a lista de logins do localStorage
                var loginsData = localStorage.getItem("loginsData")
                var logins = []

                if (loginsData) {
                    // Converte a string JSON em uma lista de logins
                    logins = JSON.parse(loginsData)
                }

                // Verifica se o login está cadastrado
                var loginEncontrado = logins.find(login => login.usn === usuario && login.psw === senha)

                if (loginEncontrado) {
                    container = document.querySelector("#container")
                    container.remove()                                                                      ////////////////////////////////EM VEZ DO REMOVE TROAR DE ARQUIVOS

                    dashboard(usuario) // Passa o usuário como parâmetro para a função dashboard
                } else {
                    alert("Login não cadastrado. Verifique seu Usuário e Senha.")
                }
            }
        }

        function dashboard(usuario) {
            let body = document.querySelector("body")
            let dashboard = document.createElement("div")
            dashboard.id = "dashboard"
            body.appendChild(dashboard)

            let divEsquerda = document.createElement("div")
            divEsquerda.id = "divEsq"                               /////////////////// NA DIV ESQUERDA CRIAR UM BOTAO PAR VOLTAR PARA TELA DE LOGIN
            dashboard.appendChild(divEsquerda)

            let divGrafico = document.createElement("div")
            divGrafico.id = "divGraf"
            dashboard.appendChild(divGrafico)
            
            divGrafico.innerHTML = "<div id='escolhaAnoDeAnalise'><h1>Escolha um Ano de Análise</h1></div>"

            let divCabecalho = document.createElement("div")
            divCabecalho.id = "divCab"
            divCabecalho.innerHTML = `<h2 id="user">${usuario}</h2><br><h3 id="textGap">PETR3<br>Petroleo Brasileiro SA Petrobras<br></h3><br><h3 id="analiseText">Ano de Análise</h3><h4 id="Ano2022">2022</h4><h4 id="Ano2023">2023</h4>`
            divEsquerda.appendChild(divCabecalho)

            let Ano2022 = document.querySelector("#Ano2022")
            let Ano2023 = document.querySelector("#Ano2023")

            let graficoCriado2022 = false
            Ano2022.addEventListener("click", function() {
                if (!graficoCriado2022) {
                    divGrafico.innerHTML = ""
                    Ano2022.style.borderColor = "rgb(51%, 34%, 90%);"
                    let ano = "2022"
                    carregaDados(ano)
                    graficoCriado2022 = true
                    graficoCriado2023 = false
                }
            })
            let graficoCriado2023 = false
            Ano2023.addEventListener("click", function() {
                if (!graficoCriado2023) {
                    divGrafico.innerHTML = ""
                    let ano = "2023"
                    carregaDados(ano)
                    graficoCriado2023 = true
                    graficoCriado2022 = false
                }
            })
        }
        
        function carregaDados(ano) {
            // Acessando os dados da PETR3
            fetch("http://localhost:8000/historico/PETR3")
            .then((resposta)=> {
                console.log("Processando dados...")
                return resposta.json()
            })
            .then((cotacao)=>{
                let cotacaoAnos = cotacao
                criaGrafico(cotacao, ano)
            })
            .catch((erro)=>{
                console.log(`Erro na requisição: ${erro}`)
            })
            .finally(()=>{
                console.log(`Processamento terminado`)
            })
        }

        function criaGrafico(cotacao, ano) {
            let divGrafico = document.getElementById('divGraf')
            let canvas = document.createElement("canvas")
            canvas.id = "canvas"
            
            canvas.id = "grafico"
            divGrafico.appendChild(canvas)

            // Formatando os dados para serem usados no gráfico
            let meses = []
            let meses2022 = []
            let meses2023 = []
            let precoAbertura = []
            let precoFechamento = []
            let precoAbertura2022 = []
            let precoFechamento2022 = []
            let precoAbertura2023 = []
            let precoFechamento2023 = []
            let i = 0
            for (i=0; i<250; i++) {
                meses.push(cotacao[i].Date)
                precoAbertura.push(cotacao[i].Open)
                precoFechamento.push(cotacao[i].Close)
            }
            if (ano === "2022") {
                for (i=0; i<250; i+=2) { // dados de 59 dias em 2022 (usando metade)
                    if (meses[i][3] === "2") { // caso o ano seja 2022
                        meses2022.push(meses[i][5] + meses[i][6] + "/" + meses[i][8] + meses[i][9])
                        precoAbertura2022.push(precoAbertura[i])
                        precoFechamento2022.push(precoFechamento[i])
                    }
                }
                var gapDeAbertura = calcularGap(precoAbertura2022, precoFechamento2022) // Calcula o valor do gab de abertura do ano 2022
                var labels = meses2022// Rótulos para o eixo X
            } else {
                for (i=0; i<250; i+=6) { // dados de 191 dias de 2023 (usando 1/6)
                    if (meses[i][3] === "3") { // caso o ano seja 2023
                        meses2023.push(meses[i][5] + meses[i][6] + "/" + meses[i][8] + meses[i][9])
                        precoAbertura2023.push(precoAbertura[i])
                        precoFechamento2023.push(precoFechamento[i])
                    }
                }
                var gapDeAbertura = calcularGap(precoAbertura2023, precoFechamento2023) // Calcula o valor do gab de abertura do ano 2023
                var labels = meses2023// Rótulos para o eixo X
            }

            // Implementação do Gráfico
            const dataPoints = gapDeAbertura // Valores para o eixo Y

            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Gaps de Abertura PETR3`,
                        data: dataPoints,
                        fill: false,
                        borderColor: 'rgb(51%, 34%, 90%)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true, // Torna o gráfico responsivo
                    scales: {
                        x: {
                            beginAtZero: true
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            }

            // Renderiza o gráfico no canvas
            const ctx = canvas.getContext('2d');
            new Chart(ctx, config);
        }

        function calcularGap(precoAberturaAno, precoFechamentoAno) {
            let gapDeAbertura = []
            for (let i=0; i<precoAberturaAno.length; i++) {
                gapDeAbertura.push(precoFechamentoAno[i] - precoAberturaAno[i])
            }
            return gapDeAbertura
        }
    </script>
</body>
</html>
